{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}{{ request.name }} - ProbeFlex{% endblock %}

{% block content %}
<!-- Add CSRF token for AJAX requests -->
{% csrf_token %}

<div class="container-fluid px-0">
    <!-- Hidden JSON data scripts - Use json_script for safer JSON rendering -->
    {{ request.headers|json_script:"headers-data" }}
    {{ request.params|json_script:"params-data" }}
    {{ request.body|json_script:"body-data" }}
    {{ request.auth|json_script:"auth-data" }}
    {{ request.id|json_script:"request-id" }}
    {{ request.url|json_script:"request-url" }}
    {{ request.method|json_script:"request-method" }}
    {{ request.follow_redirects|json_script:"follow-redirects" }}
    {{ request.verify_ssl|json_script:"verify-ssl" }}
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>{{ request.name }}</h2>
            <div class="text-muted">
                <span class="badge bg-{{ request.method|lower }}">{{ request.method }}</span>
                {{ request.url }}
            </div>
        </div>
        <div>
            <a href="{% url 'collection_detail' request.collection.id %}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-1"></i> Back to Collection
            </a>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <div class="d-flex align-items-center mb-3">
                <div class="flex-grow-1">
                    <div class="input-group">
                        <select class="form-select flex-grow-0" style="width: 120px;" id="method-ajax" disabled>
                            <option value="{{ request.method }}" selected>{{ request.method }}</option>
                        </select>
                        <input type="text" class="form-control" id="url-ajax" value="{{ request.url }}" readonly>
                        <button class="btn btn-primary" id="send-btn-ajax">Send</button>
                    </div>
                </div>
                <div class="ms-2">
                    <a href="/requests/{{ request.id }}/edit/" class="btn btn-outline-secondary">
                        <i class="fas fa-edit me-1"></i> Edit
                    </a>
                </div>
            </div>

            <ul class="nav nav-tabs" id="requestTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="params-tab" data-bs-toggle="tab" data-bs-target="#params" type="button" role="tab" aria-controls="params" aria-selected="true">Params</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="auth-tab" data-bs-toggle="tab" data-bs-target="#auth" type="button" role="tab" aria-controls="auth" aria-selected="false">Auth</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="headers-tab" data-bs-toggle="tab" data-bs-target="#headers" type="button" role="tab" aria-controls="headers" aria-selected="false">Headers</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="body-tab" data-bs-toggle="tab" data-bs-target="#body" type="button" role="tab" aria-controls="body" aria-selected="false">Body</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab" aria-controls="settings" aria-selected="false">Settings</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false">History</button>
                </li>
            </ul>

            <div class="tab-content" id="requestTabsContent">
                <!-- Params Tab -->
                <div class="tab-pane fade show active" id="params" role="tabpanel" aria-labelledby="params-tab">
                    {% if request.params %}
                    <div class="mt-3">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Key</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for key, value in request.params.items %}
                                <tr>
                                    <td>{{ key }}</td>
                                    <td>{{ value }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="mt-3">
                        <p class="text-muted">No parameters configured.</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Auth Tab -->
                <div class="tab-pane fade" id="auth" role="tabpanel" aria-labelledby="auth-tab">
                    <div class="mt-3">
                        {% if request.auth and request.auth.type %}
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5>Authentication Type: {{ request.auth.type|default:"None"|title }}</h5>
                                
                                {% if request.auth.type == 'basic' %}
                                <div class="mt-3">
                                    <p><strong>Username:</strong> {{ request.auth.username }}</p>
                                    <p><strong>Password:</strong> ••••••••</p>
                                </div>
                                {% elif request.auth.type == 'bearer' %}
                                <div class="mt-3">
                                    <p><strong>Token:</strong> {{ request.auth.token|truncatechars:20 }}</p>
                                </div>
                                {% elif request.auth.type == 'apikey' %}
                                <div class="mt-3">
                                    <p><strong>Key Name:</strong> {{ request.auth.key }}</p>
                                    <p><strong>Key Value:</strong> {{ request.auth.value|truncatechars:20 }}</p>
                                    <p><strong>Location:</strong> {{ request.auth.location|title }}</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <p class="text-muted">No authentication configured.</p>
                        {% endif %}
                        
                        <!-- Hidden fields for auth to work with send_request.js -->
                        <div style="display: none;">
                            <select id="auth-type">
                                <option value="{{ request.auth.type|default:'none' }}" selected></option>
                            </select>
                            <input type="text" id="basic-username" value="{{ request.auth.username|default:'' }}">
                            <input type="password" id="basic-password" value="{{ request.auth.password|default:'' }}">
                            <input type="text" id="bearer-token" value="{{ request.auth.token|default:'' }}">
                            <input type="text" id="apikey-name" value="{{ request.auth.key|default:'' }}">
                            <input type="text" id="apikey-value" value="{{ request.auth.value|default:'' }}">
                            <select id="apikey-location">
                                <option value="{{ request.auth.location|default:'header' }}" selected></option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Headers Tab -->
                <div class="tab-pane fade" id="headers" role="tabpanel" aria-labelledby="headers-tab">
                    {% if request.headers %}
                    <div class="mt-3">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Key</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for key, value in request.headers.items %}
                                <tr>
                                    <td>{{ key }}</td>
                                    <td>{{ value }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="mt-3">
                        <p class="text-muted">No headers configured.</p>
                    </div>
                    {% endif %}
                    
                    <!-- Hidden field for headers to work with send_request.js -->
                    <div style="display: none;" class="header-rows"></div>
                </div>

                <!-- Body Tab -->
                <div class="tab-pane fade" id="body" role="tabpanel" aria-labelledby="body-tab">
                    <div class="mt-3">
                        {% if request.body %}
                        <div class="card bg-light">
                            <div class="card-header">
                                Body Type: 
                                {% if request.body.items %}
                                JSON
                                {% else %}
                                Raw
                                {% endif %}
                            </div>
                            <div class="card-body">
                                <pre class="mb-0"><code>{{ request.body|pprint }}</code></pre>
                            </div>
                        </div>
                        {% else %}
                        <p class="text-muted">No request body configured.</p>
                        {% endif %}
                        
                        <!-- Hidden fields for body to work with send_request.js -->
                        <div style="display: none;">
                            <select id="body-type">
                                <option value="none">No Body</option>
                                <option value="json" {% if request.body %}selected{% endif %}>JSON</option>
                                <option value="form">Form Data</option>
                                <option value="raw">Raw</option>
                            </select>
                            <textarea id="json-editor">{{ request.body|pprint }}</textarea>
                            <textarea id="raw-editor"></textarea>
                            <div class="form-rows"></div>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                    <div class="mt-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Request Timeout</label>
                                    <p class="mb-0">{{ request.timeout }} ms</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Follow Redirects</label>
                                    <p class="mb-0">{{ request.follow_redirects|yesno:"Yes,No" }}</p>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Verify SSL Certificates</label>
                                    <p class="mb-0">{{ request.verify_ssl|yesno:"Yes,No" }}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden fields for settings to work with send_request.js -->
                        <div style="display: none;">
                            <input type="number" id="timeout" value="{{ request.timeout }}">
                            <input type="checkbox" id="follow-redirects" {% if request.follow_redirects %}checked{% endif %}>
                            <input type="checkbox" id="verify-ssl" {% if request.verify_ssl %}checked{% endif %}>
                        </div>
                    </div>
                </div>

                <!-- History Tab -->
                <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
                    {% if history %}
                    <div class="mt-3">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Response Time</th>
                                        <th>Executed By</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for entry in history %}
                                    <tr>
                                        <td>{{ entry.executed_at|date:"M d, Y H:i:s" }}</td>
                                        <td>
                                            <span class="badge {% if entry.response_status < 400 %}bg-success{% elif entry.response_status < 500 %}bg-warning{% else %}bg-danger{% endif %}">
                                                {{ entry.response_status }}
                                            </span>
                                        </td>
                                        <td>{{ entry.response_time|floatformat:2 }} ms</td>
                                        <td>{{ entry.executed_by.username }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% else %}
                    <div class="mt-3">
                        <p class="text-muted">No execution history yet. Send a request to see results.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Response Section -->
    <div class="card mt-3 border-0 shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Response</h5>
            <div>
                <span id="status-code" class="badge bg-secondary">Waiting for response</span>
                <span id="response-time" class="ms-2">0 ms</span>
            </div>
        </div>
        <div class="card-body">
            <ul class="nav nav-tabs" id="responseTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="response-body-tab" data-bs-toggle="tab" data-bs-target="#response-body" type="button" role="tab">Body</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="response-headers-tab" data-bs-toggle="tab" data-bs-target="#response-headers" type="button" role="tab">Headers</button>
                </li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="response-body" role="tabpanel">
                    <div class="response-container mt-3" id="response-body-content">
                        <p class="text-muted">Send a request to see the response</p>
                    </div>
                </div>
                <div class="tab-pane fade" id="response-headers" role="tabpanel">
                    <div class="response-container mt-3" id="response-headers-content">
                        <p class="text-muted">Send a request to see the response headers</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden form fields for param-rows to work with send_request.js -->
<div style="display: none;">
    <div class="param-rows"></div>
</div>

<!-- Add a div for headers-rows that was missing -->
<div style="display: none;">
    <div class="header-rows"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/send_request.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Sayfa yüklendiğinde JSON verilerini gizli form elemanlarına yükle
        try {
            // Güvenli JSON parse fonksiyonu - Django'nun json_script filter'ı ile çalışır
            function safeJsonParse(elementId, defaultValue = {}) {
                try {
                    const element = document.getElementById(elementId);
                    if (!element) {
                        console.warn(`Element ${elementId} not found`);
                        return defaultValue;
                    }
                    
                    // Django json_script filter uses textContent directly
                    const data = JSON.parse(element.textContent);
                    return data;
                } catch (e) {
                    console.error(`JSON parse error for ${elementId}:`, e);
                    console.error('Raw text:', element ? element.textContent : 'Element not found');
                    return defaultValue;
                }
            }
            
            // Güvenli element alma fonksiyonu
            function safeGetElement(id) {
                const element = document.getElementById(id);
                if (!element) {
                    console.warn(`Element ${id} not found`);
                }
                return element;
            }
            
            // JSON verilerini al ve konsola yazdır (hata ayıklama için)
            const headersElement = safeGetElement('headers-data');
            const paramsElement = safeGetElement('params-data');
            const bodyElement = safeGetElement('body-data');
            const authElement = safeGetElement('auth-data');
            const urlElement = safeGetElement('request-url');
            const methodElement = safeGetElement('request-method');
            
            console.log('Headers raw:', headersElement ? headersElement.textContent : 'Element not found');
            console.log('Params raw:', paramsElement ? paramsElement.textContent : 'Element not found');
            console.log('Body raw:', bodyElement ? bodyElement.textContent : 'Element not found');
            console.log('Auth raw:', authElement ? authElement.textContent : 'Element not found');
            console.log('URL raw:', urlElement ? urlElement.textContent : 'Element not found');
            console.log('Method raw:', methodElement ? methodElement.textContent : 'Element not found');
            
            // Her bir JSON verisini güvenli şekilde parse edelim
            const headers = safeJsonParse('headers-data', {});
            const params = safeJsonParse('params-data', {});
            const body = safeJsonParse('body-data', {});
            const auth = safeJsonParse('auth-data', {});
            const api_request_id = safeJsonParse('request-id', null);
            
            console.log('Parsed headers:', headers);
            console.log('Parsed params:', params);
            console.log('Parsed body:', body);
            console.log('Parsed auth:', auth);
            console.log('Parsed request ID:', api_request_id);
            
            // URL ve method bilgilerini form elemanlarına yükle
            let url = '';
            let method = '';
            
            if (urlElement) {
                try {
                    const urlText = urlElement.textContent.trim();
                    if (urlText && urlText !== '""' && urlText !== 'null') {
                        // Eğer text zaten quotes içindeyse JSON parse et, değilse direkt kullan
                        if (urlText.startsWith('"') && urlText.endsWith('"')) {
                            url = JSON.parse(urlText);
                        } else {
                            url = urlText;
                        }
                    }
                } catch (e) {
                    console.error('URL parse hatası:', e);
                    // Fallback - quotes'ları temizle
                    url = urlElement.textContent.trim().replace(/^"|"$/g, '');
                }
                
                const urlAjaxElement = safeGetElement('url-ajax');
                if (urlAjaxElement && url) {
                    urlAjaxElement.value = url;
                }
            }
            
            if (methodElement) {
                try {
                    const methodText = methodElement.textContent.trim();
                    if (methodText && methodText !== '""' && methodText !== 'null') {
                        // Eğer text zaten quotes içindeyse JSON parse et, değilse direkt kullan
                        if (methodText.startsWith('"') && methodText.endsWith('"')) {
                            method = JSON.parse(methodText);
                        } else {
                            method = methodText;
                        }
                    }
                } catch (e) {
                    console.error('Method parse hatası:', e);
                    // Fallback - quotes'ları temizle
                    method = methodElement.textContent.trim().replace(/^"|"$/g, '');
                }
                
                if (method) {
                    try {
                        const methodSelectElement = document.querySelector('#method-ajax option[value="' + method + '"]');
                        if (methodSelectElement) {
                            methodSelectElement.selected = true;
                        }
                    } catch (selectError) {
                        console.error('Method select hatası:', selectError);
                    }
                }
            }
            
            // Auth bilgilerini ilgili form alanlarına yükle
            const authTypeElement = safeGetElement('auth-type');
            if (auth && auth.type && authTypeElement) {
                authTypeElement.value = auth.type || 'none';
                
                if (auth.type === 'basic') {
                    const usernameElement = safeGetElement('basic-username');
                    const passwordElement = safeGetElement('basic-password');
                    if (usernameElement) usernameElement.value = auth.username || '';
                    if (passwordElement) passwordElement.value = auth.password || '';
                } else if (auth.type === 'bearer') {
                    const tokenElement = safeGetElement('bearer-token');
                    if (tokenElement) tokenElement.value = auth.token || '';
                } else if (auth.type === 'apikey') {
                    const keyNameElement = safeGetElement('apikey-name');
                    const keyValueElement = safeGetElement('apikey-value');
                    const keyLocationElement = safeGetElement('apikey-location');
                    if (keyNameElement) keyNameElement.value = auth.key || '';
                    if (keyValueElement) keyValueElement.value = auth.value || '';
                    if (keyLocationElement) keyLocationElement.value = auth.location || 'header';
                }
            }
            
            // Diğer ayarları form elemanlarına yükle
            const followRedirectsData = safeJsonParse('follow-redirects', true);
            const verifySSLData = safeJsonParse('verify-ssl', true);
            
            const followRedirectsElement = safeGetElement('follow-redirects');
            const verifySSLElement = safeGetElement('verify-ssl');
            
            if (followRedirectsElement) {
                followRedirectsElement.checked = followRedirectsData;
            }
            if (verifySSLElement) {
                verifySSLElement.checked = verifySSLData;
            }
            
            // Headers için gizli alanları ekle
            const headerRows = document.querySelector('.header-rows');
            if (headerRows) {
                headerRows.innerHTML = ''; // Temizle
                
                console.log('Adding headers to hidden fields:', headers);
                if (headers && typeof headers === 'object') {
                    Object.entries(headers).forEach(([key, value]) => {
                        const row = document.createElement('div');
                        row.className = 'row mb-2';
                        
                        // Güvenli bir şekilde HTML içeriği oluştur
                        const safeKey = String(key).replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        const safeValue = String(value).replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        
                        row.innerHTML = `
                            <div class="col-5">
                                <input type="hidden" class="form-control header-key" value="${safeKey}">
                            </div>
                            <div class="col-5">
                                <input type="hidden" class="form-control header-value" value="${safeValue}">
                            </div>
                        `;
                        headerRows.appendChild(row);
                    });
                }
            }
            
            // Params için gizli alanları ekle
            const paramRows = document.querySelector('.param-rows');
            if (paramRows) {
                paramRows.innerHTML = ''; // Temizle
                
                console.log('Adding params to hidden fields:', params);
                if (params && typeof params === 'object') {
                    Object.entries(params).forEach(([key, value]) => {
                        const row = document.createElement('div');
                        row.className = 'row mb-2';
                        
                        // Güvenli bir şekilde HTML içeriği oluştur
                        const safeKey = String(key).replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        const safeValue = String(value).replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        
                        row.innerHTML = `
                            <div class="col-5">
                                <input type="hidden" class="form-control param-key" value="${safeKey}">
                            </div>
                            <div class="col-5">
                                <input type="hidden" class="form-control param-value" value="${safeValue}">
                            </div>
                        `;
                        paramRows.appendChild(row);
                    });
                }
            }
            
            // Body verisini ilgili editöre yükle
            console.log('Setting body value:', body);
            const jsonEditorElement = safeGetElement('json-editor');
            const rawEditorElement = safeGetElement('raw-editor');
            const bodyTypeElement = safeGetElement('body-type');
            
            if (body && typeof body === 'object' && Object.keys(body).length > 0) {
                if (jsonEditorElement) {
                    // Only stringify if it's already a parsed object
                    if (typeof body === 'object') {
                        jsonEditorElement.value = JSON.stringify(body, null, 2);
                    } else {
                        // If it's already a string, use it as is
                        jsonEditorElement.value = body;
                    }
                }
                if (bodyTypeElement) {
                    bodyTypeElement.value = 'json';
                }
            } else if (typeof body === 'string' && body.trim()) {
                // Check if the string is actually JSON
                try {
                    const parsedBody = JSON.parse(body);
                    // If it parses successfully, it's JSON - put it in JSON editor
                    if (jsonEditorElement) {
                        jsonEditorElement.value = JSON.stringify(parsedBody, null, 2);
                    }
                    if (bodyTypeElement) {
                        bodyTypeElement.value = 'json';
                    }
                } catch (e) {
                    // If it doesn't parse, it's raw text
                    if (rawEditorElement) {
                        rawEditorElement.value = body;
                    }
                    if (bodyTypeElement) {
                        bodyTypeElement.value = 'raw';
                    }
                }
            } else {
                // Empty body - set to none
                if (bodyTypeElement) {
                    bodyTypeElement.value = 'none';
                }
            }

        } catch (e) {
            console.error('JSON verilerini işlerken genel hata oluştu:', e);
        }
        
        // Send butonuna tıklayınca direkt standart sendRequest() fonksiyonunu çağır
        const sendBtnElement = safeGetElement('send-btn-ajax');
        if (sendBtnElement) {
            sendBtnElement.addEventListener('click', function() {
                try {
                    if (typeof sendRequest === 'function') {
                        sendRequest();
                    } else {
                        console.error('sendRequest function not found');
                        alert('Send request function not available');
                    }
                } catch (e) {
                    console.error('sendRequest çağrılırken hata:', e);
                    alert('İstek gönderme hatası: ' + e.message);
                }
            });
        }
    });
</script>
{% endblock %} 