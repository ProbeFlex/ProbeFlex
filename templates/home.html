{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}ProbeFlex - API Testing Tool{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <div class="d-flex align-items-center mb-3">
                <div class="flex-grow-1">
                    <div class="input-group">
                        <select class="form-select flex-grow-0" style="width: 120px;" id="method">
                            <option value="GET">GET</option>
                            <option value="POST">POST</option>
                            <option value="PUT">PUT</option>
                            <option value="PATCH">PATCH</option>
                            <option value="DELETE">DELETE</option>
                            <option value="HEAD">HEAD</option>
                            <option value="OPTIONS">OPTIONS</option>
                        </select>
                        <input type="text" class="form-control" id="url" placeholder="Enter URL (e.g. https://api.example.com/v1/endpoint)">
                        <button class="btn btn-primary" id="send-btn">Send</button>
                    </div>
                </div>
                <div class="ms-2">
                    <button class="btn btn-outline-secondary" id="save-btn">Save</button>
                </div>
            </div>

            <ul class="nav nav-tabs" id="requestTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="params-tab" data-bs-toggle="tab" data-bs-target="#params" type="button" role="tab" aria-controls="params" aria-selected="true">Params</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="auth-tab" data-bs-toggle="tab" data-bs-target="#auth" type="button" role="tab" aria-controls="auth" aria-selected="false">Auth</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="headers-tab" data-bs-toggle="tab" data-bs-target="#headers" type="button" role="tab" aria-controls="headers" aria-selected="false">Headers</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="body-tab" data-bs-toggle="tab" data-bs-target="#body" type="button" role="tab" aria-controls="body" aria-selected="false">Body</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab" aria-controls="settings" aria-selected="false">Settings</button>
                </li>
            </ul>

            <div class="tab-content" id="requestTabsContent">
                <!-- Params Tab -->
                <div class="tab-pane fade show active" id="params" role="tabpanel" aria-labelledby="params-tab">
                    <div class="param-rows">
                        <div class="row mb-2">
                            <div class="col-5">
                                <input type="text" class="form-control param-key" placeholder="Key">
                            </div>
                            <div class="col-5">
                                <input type="text" class="form-control param-value" placeholder="Value">
                            </div>
                            <div class="col-2">
                                <button class="btn btn-sm btn-outline-danger remove-param">Remove</button>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-primary mt-2" id="add-param">Add Parameter</button>
                </div>

                <!-- Auth Tab -->
                <div class="tab-pane fade" id="auth" role="tabpanel" aria-labelledby="auth-tab">
                    <div class="mt-3">
                        <select class="form-select" id="auth-type">
                            <option value="none">No Auth</option>
                            <option value="basic">Basic Auth</option>
                            <option value="bearer">Bearer Token</option>
                            <option value="apikey">API Key</option>
                        </select>

                        <div class="mt-3 auth-details" id="basic-auth-details" style="display: none;">
                            <div class="mb-3">
                                <label for="basic-username" class="form-label">Username</label>
                                <input type="text" class="form-control" id="basic-username">
                            </div>
                            <div class="mb-3">
                                <label for="basic-password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="basic-password">
                            </div>
                        </div>

                        <div class="mt-3 auth-details" id="bearer-auth-details" style="display: none;">
                            <div class="mb-3">
                                <label for="bearer-token" class="form-label">Token</label>
                                <input type="text" class="form-control" id="bearer-token">
                            </div>
                        </div>

                        <div class="mt-3 auth-details" id="apikey-auth-details" style="display: none;">
                            <div class="mb-3">
                                <label for="apikey-name" class="form-label">Key Name</label>
                                <input type="text" class="form-control" id="apikey-name">
                            </div>
                            <div class="mb-3">
                                <label for="apikey-value" class="form-label">Key Value</label>
                                <input type="text" class="form-control" id="apikey-value">
                            </div>
                            <div class="mb-3">
                                <label for="apikey-location" class="form-label">Add to</label>
                                <select class="form-control" id="apikey-location">
                                    <option value="header">Header</option>
                                    <option value="query">Query Parameter</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Headers Tab -->
                <div class="tab-pane fade" id="headers" role="tabpanel" aria-labelledby="headers-tab">
                    <div class="header-rows">
                        <div class="row mb-2">
                            <div class="col-5">
                                <input type="text" class="form-control header-key" placeholder="Key">
                            </div>
                            <div class="col-5">
                                <input type="text" class="form-control header-value" placeholder="Value">
                            </div>
                            <div class="col-2">
                                <button class="btn btn-sm btn-outline-danger remove-header">Remove</button>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-primary mt-2" id="add-header">Add Header</button>
                </div>

                <!-- Body Tab -->
                <div class="tab-pane fade" id="body" role="tabpanel" aria-labelledby="body-tab">
                    <div class="mt-3">
                        <select class="form-select mb-3" id="body-type">
                            <option value="none">No Body</option>
                            <option value="json">JSON</option>
                            <option value="form">Form Data</option>
                            <option value="raw">Raw</option>
                        </select>

                        <div class="body-inputs" id="json-body" style="display: none;">
                            <textarea class="form-control" id="json-editor" rows="10" placeholder='{ "key": "value" }'></textarea>
                        </div>

                        <div class="body-inputs" id="form-body" style="display: none;">
                            <div class="form-rows">
                                <div class="row mb-2">
                                    <div class="col-5">
                                        <input type="text" class="form-control form-key" placeholder="Key">
                                    </div>
                                    <div class="col-5">
                                        <input type="text" class="form-control form-value" placeholder="Value">
                                    </div>
                                    <div class="col-2">
                                        <button class="btn btn-sm btn-outline-danger remove-form-item">Remove</button>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-outline-primary mt-2" id="add-form-item">Add Form Item</button>
                        </div>

                        <div class="body-inputs" id="raw-body" style="display: none;">
                            <textarea class="form-control" id="raw-editor" rows="10" placeholder="Raw request body"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                    <div class="mt-3">
                        <div class="mb-3">
                            <label for="timeout" class="form-label">Request Timeout (ms)</label>
                            <input type="number" class="form-control" id="timeout" value="30000">
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="follow-redirects" checked>
                                <label class="form-check-label" for="follow-redirects">
                                    Follow Redirects
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Response Section -->
    <div class="card mt-3 border-0 shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Response</h5>
            <div>
                <span id="status-code" class="badge bg-secondary">Waiting for response</span>
                <span id="response-time" class="ms-2">0 ms</span>
            </div>
        </div>
        <div class="card-body">
            <ul class="nav nav-tabs" id="responseTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="response-body-tab" data-bs-toggle="tab" data-bs-target="#response-body" type="button" role="tab" aria-controls="response-body" aria-selected="true">Body</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="response-headers-tab" data-bs-toggle="tab" data-bs-target="#response-headers" type="button" role="tab" aria-controls="response-headers" aria-selected="false">Headers</button>
                </li>
            </ul>

            <div class="tab-content" id="responseTabsContent">
                <div class="tab-pane fade show active" id="response-body" role="tabpanel" aria-labelledby="response-body-tab">
                    <div class="response-container mt-3" id="response-body-content">
                        <p class="text-muted">Send a request to see the response</p>
                    </div>
                </div>
                <div class="tab-pane fade" id="response-headers" role="tabpanel" aria-labelledby="response-headers-tab">
                    <div class="response-container mt-3" id="response-headers-content">
                        <p class="text-muted">Send a request to see the response headers</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for saving request -->
<div class="modal fade" id="saveRequestModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Save Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="request-name" class="form-label">Request Name</label>
                    <input type="text" class="form-control" id="request-name" placeholder="My API Request">
                </div>
                <div class="mb-3">
                    <label for="request-description" class="form-label">Description (optional)</label>
                    <textarea class="form-control" id="request-description" rows="3"></textarea>
                </div>
                <div class="mb-3">
                    <label for="collection-select" class="form-label">Collection</label>
                    <select class="form-select" id="collection-select">
                        <option value="">Select Collection</option>
                        {% for project in projects %}
                            <optgroup label="{{ project.name }}">
                                {% for collection in project.collections.all %}
                                    <option value="{{ collection.id }}">{{ collection.name }}</option>
                                {% endfor %}
                            </optgroup>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-request-btn">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auth type toggle
        document.getElementById('auth-type').addEventListener('change', function() {
            const authType = this.value;
            document.querySelectorAll('.auth-details').forEach(el => el.style.display = 'none');
            if (authType !== 'none') {
                document.getElementById(`${authType}-auth-details`).style.display = 'block';
            }
        });

        // Body type toggle
        document.getElementById('body-type').addEventListener('change', function() {
            const bodyType = this.value;
            document.querySelectorAll('.body-inputs').forEach(el => el.style.display = 'none');
            if (bodyType !== 'none') {
                document.getElementById(`${bodyType}-body`).style.display = 'block';
            }
        });

        // Add param button
        document.getElementById('add-param').addEventListener('click', function() {
            const paramRow = document.createElement('div');
            paramRow.className = 'row mb-2';
            paramRow.innerHTML = `
                <div class="col-5">
                    <input type="text" class="form-control param-key" placeholder="Key">
                </div>
                <div class="col-5">
                    <input type="text" class="form-control param-value" placeholder="Value">
                </div>
                <div class="col-2">
                    <button class="btn btn-sm btn-outline-danger remove-param">Remove</button>
                </div>
            `;
            document.querySelector('.param-rows').appendChild(paramRow);
            
            // Add event listener to the newly created remove button
            paramRow.querySelector('.remove-param').addEventListener('click', function() {
                paramRow.remove();
            });
        });

        // Add header button
        document.getElementById('add-header').addEventListener('click', function() {
            const headerRow = document.createElement('div');
            headerRow.className = 'row mb-2';
            headerRow.innerHTML = `
                <div class="col-5">
                    <input type="text" class="form-control header-key" placeholder="Key">
                </div>
                <div class="col-5">
                    <input type="text" class="form-control header-value" placeholder="Value">
                </div>
                <div class="col-2">
                    <button class="btn btn-sm btn-outline-danger remove-header">Remove</button>
                </div>
            `;
            document.querySelector('.header-rows').appendChild(headerRow);
            
            // Add event listener to the newly created remove button
            headerRow.querySelector('.remove-header').addEventListener('click', function() {
                headerRow.remove();
            });
        });

        // Add form item button
        document.getElementById('add-form-item').addEventListener('click', function() {
            const formRow = document.createElement('div');
            formRow.className = 'row mb-2';
            formRow.innerHTML = `
                <div class="col-5">
                    <input type="text" class="form-control form-key" placeholder="Key">
                </div>
                <div class="col-5">
                    <input type="text" class="form-control form-value" placeholder="Value">
                </div>
                <div class="col-2">
                    <button class="btn btn-sm btn-outline-danger remove-form-item">Remove</button>
                </div>
            `;
            document.querySelector('.form-rows').appendChild(formRow);
            
            // Add event listener to the newly created remove button
            formRow.querySelector('.remove-form-item').addEventListener('click', function() {
                formRow.remove();
            });
        });

        // Add remove button event listeners for initial rows
        document.querySelectorAll('.remove-param, .remove-header, .remove-form-item').forEach(button => {
            button.addEventListener('click', function() {
                this.closest('.row').remove();
            });
        });

        // Send button
        document.getElementById('send-btn').addEventListener('click', function() {
            sendRequest();
        });

        // Save button
        document.getElementById('save-btn').addEventListener('click', function() {
            const modal = new bootstrap.Modal(document.getElementById('saveRequestModal'));
            modal.show();
        });

        // Save request button in modal
        document.getElementById('save-request-btn').addEventListener('click', function() {
            saveRequest();
        });

        function getParams() {
            const params = {};
            document.querySelectorAll('.param-rows .row').forEach(row => {
                const key = row.querySelector('.param-key').value.trim();
                const value = row.querySelector('.param-value').value.trim();
                if (key) {
                    params[key] = value;
                }
            });
            return params;
        }

        function getHeaders() {
            const headers = {};
            document.querySelectorAll('.header-rows .row').forEach(row => {
                const key = row.querySelector('.header-key').value.trim();
                const value = row.querySelector('.header-value').value.trim();
                if (key) {
                    headers[key] = value;
                }
            });
            
            // Add auth headers if needed
            const authType = document.getElementById('auth-type').value;
            if (authType === 'bearer') {
                const token = document.getElementById('bearer-token').value;
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
            } else if (authType === 'apikey') {
                const keyName = document.getElementById('apikey-name').value;
                const keyValue = document.getElementById('apikey-value').value;
                const location = document.getElementById('apikey-location').value;
                
                if (keyName && keyValue && location === 'header') {
                    headers[keyName] = keyValue;
                }
            }
            
            return headers;
        }

        function getBody() {
            const bodyType = document.getElementById('body-type').value;
            
            if (bodyType === 'json') {
                const jsonText = document.getElementById('json-editor').value.trim();
                try {
                    return jsonText ? JSON.parse(jsonText) : {};
                } catch (e) {
                    alert('Invalid JSON: ' + e.message);
                    return {};
                }
            } else if (bodyType === 'form') {
                const formData = {};
                document.querySelectorAll('.form-rows .row').forEach(row => {
                    const key = row.querySelector('.form-key').value.trim();
                    const value = row.querySelector('.form-value').value.trim();
                    if (key) {
                        formData[key] = value;
                    }
                });
                return formData;
            } else if (bodyType === 'raw') {
                return document.getElementById('raw-editor').value;
            }
            
            return {};
        }

        function getAuth() {
            const authType = document.getElementById('auth-type').value;
            const auth = { type: authType };
            
            if (authType === 'basic') {
                auth.username = document.getElementById('basic-username').value;
                auth.password = document.getElementById('basic-password').value;
            } else if (authType === 'bearer') {
                auth.token = document.getElementById('bearer-token').value;
            } else if (authType === 'apikey') {
                auth.key = document.getElementById('apikey-name').value;
                auth.value = document.getElementById('apikey-value').value;
                auth.location = document.getElementById('apikey-location').value;
            }
            
            return auth;
        }

        function updateQueryParams(url, params) {
            const urlObj = new URL(url);
            for (const [key, value] of Object.entries(params)) {
                urlObj.searchParams.set(key, value);
            }
            return urlObj.toString();
        }

        function formatJsonOutput(json) {
            const formatter = new JSONFormatter(json, 2, {
                hoverPreviewEnabled: true,
                hoverPreviewArrayCount: 100,
                hoverPreviewFieldCount: 5,
                theme: 'dark',
                animateOpen: true,
                animateClose: true
            });
            
            return formatter.render();
        }

        function sendRequest() {
            const method = document.getElementById('method').value;
            let url = document.getElementById('url').value.trim();
            
            if (!url) {
                alert('Please enter a URL');
                return;
            }
            
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }
            
            const params = getParams();
            const headers = getHeaders();
            const body = getBody();
            const auth = getAuth();
            
            // Update URL with query params
            if (method === 'GET' || method === 'HEAD' || method === 'DELETE' || method === 'OPTIONS') {
                try {
                    url = updateQueryParams(url, params);
                } catch (e) {
                    alert('Invalid URL: ' + e.message);
                    return;
                }
            }
            
            // Update status indicator
            document.getElementById('status-code').textContent = 'Sending...';
            document.getElementById('status-code').className = 'badge bg-secondary';
            document.getElementById('response-time').textContent = '0 ms';
            document.getElementById('response-body-content').innerHTML = '<p class="text-muted">Waiting for response...</p>';
            document.getElementById('response-headers-content').innerHTML = '<p class="text-muted">Waiting for response...</p>';
            
            // Send the request
            fetch('/api/send/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    url: url,
                    method: method,
                    params: params,
                    headers: headers,
                    body: body,
                    auth: auth
                })
            })
            .then(response => response.json())
            .then(data => {
                // Update status code
                const statusCode = data.status_code;
                document.getElementById('status-code').textContent = statusCode;
                
                let statusClass = 'bg-secondary';
                if (statusCode >= 200 && statusCode < 300) {
                    statusClass = 'bg-success';
                } else if (statusCode >= 300 && statusCode < 400) {
                    statusClass = 'bg-info';
                } else if (statusCode >= 400 && statusCode < 500) {
                    statusClass = 'bg-warning';
                } else if (statusCode >= 500) {
                    statusClass = 'bg-danger';
                }
                document.getElementById('status-code').className = `badge ${statusClass}`;
                
                // Update response time
                document.getElementById('response-time').textContent = `${Math.round(data.time)} ms`;
                
                // Update response body
                const responseBodyContainer = document.getElementById('response-body-content');
                responseBodyContainer.innerHTML = '';
                
                if (typeof data.body === 'object') {
                    responseBodyContainer.appendChild(formatJsonOutput(data.body));
                } else {
                    responseBodyContainer.textContent = data.body;
                }
                
                // Update response headers
                const responseHeadersContainer = document.getElementById('response-headers-content');
                responseHeadersContainer.innerHTML = '';
                responseHeadersContainer.appendChild(formatJsonOutput(data.headers));
            })
            .catch(error => {
                document.getElementById('status-code').textContent = 'Error';
                document.getElementById('status-code').className = 'badge bg-danger';
                document.getElementById('response-body-content').textContent = `Error: ${error.message}`;
            });
        }

        function saveRequest() {
            const name = document.getElementById('request-name').value.trim();
            const description = document.getElementById('request-description').value.trim();
            const collectionId = document.getElementById('collection-select').value;
            
            if (!name) {
                alert('Please enter a name for this request');
                return;
            }
            
            if (!collectionId) {
                alert('Please select a collection');
                return;
            }
            
            const method = document.getElementById('method').value;
            const url = document.getElementById('url').value.trim();
            
            if (!url) {
                alert('Please enter a URL');
                return;
            }
            
            const requestData = {
                name: name,
                description: description,
                url: url,
                method: method,
                headers: getHeaders(),
                params: getParams(),
                body: getBody(),
                auth: getAuth(),
                collection_id: collectionId
            };
            
            fetch('/collections/' + collectionId + '/requests/new/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Error saving request');
            })
            .then(data => {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('saveRequestModal')).hide();
                
                // Show success message
                alert('Request saved successfully!');
                
                // Optionally redirect to the new request
                window.location.href = `/requests/${data.id}/`;
            })
            .catch(error => {
                alert('Error saving request: ' + error.message);
            });
        }
    });
</script>
{% endblock %} 